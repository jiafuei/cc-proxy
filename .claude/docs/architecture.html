<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CC-Proxy Architecture Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        nav {
            background: #2c3e50;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 2rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        nav a:hover, nav a.active {
            background: #34495e;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 3rem;
            display: none;
        }

        section.active {
            display: block;
        }

        h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        h3 {
            color: #34495e;
            margin: 1.5rem 0 1rem 0;
            font-size: 1.4rem;
        }

        h4 {
            color: #34495e;
            margin: 1rem 0 0.5rem 0;
            font-size: 1.2rem;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .service-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .service-title {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .service-path {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-family: monospace;
        }

        .mermaid {
            margin: 2rem 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Consolas', monospace;
            white-space: pre-line;
        }

        .highlight {
            background: #fff3cd;
            padding: 1rem;
            border-left: 4px solid #ffc107;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .flow-step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .flow-step strong {
            color: #1976d2;
        }

        .architecture-diagram {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
            margin: 2rem 0;
        }

        .interactive-controls {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.25rem;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.active {
            background: #e74c3c;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .data-table th {
            background: #f4f4f4;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge.primary { background: #007bff; color: white; }
        .badge.success { background: #28a745; color: white; }
        .badge.warning { background: #ffc107; color: #212529; }
        .badge.danger { background: #dc3545; color: white; }
        .badge.info { background: #17a2b8; color: white; }

        #flowDiagram {
            width: 100%;
            height: 800px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CC-Proxy Architecture</h1>
            <p class="subtitle">Comprehensive Analysis of the Claude API Proxy System</p>
        </header>

        <nav>
            <ul>
                <li><a href="#overview" class="nav-link active">Overview</a></li>
                <li><a href="#architecture" class="nav-link">Architecture</a></li>
                <li><a href="#services" class="nav-link">Services</a></li>
                <li><a href="#flow" class="nav-link">Message Flow</a></li>
                <li><a href="#diagrams" class="nav-link">Interactive Diagrams</a></li>
            </ul>
        </nav>

        <main>
            <section id="overview" class="active">
                <h2>System Overview</h2>
                
                <div class="highlight">
                    <strong>CC-Proxy</strong> is a sophisticated FastAPI-based proxy system designed to intercept, transform, and route Claude API requests. 
                    It provides dynamic routing, configurable transformations, error handling, and comprehensive request/response processing pipelines.
                </div>

                <h3>Key Features</h3>
                <ul style="margin-left: 2rem; margin-bottom: 1.5rem;">
                    <li><strong>Dynamic Routing</strong>: Intelligent request routing based on content analysis and user configuration</li>
                    <li><strong>Transformation Pipelines</strong>: Configurable request/response transformation chains</li>
                    <li><strong>Provider Registry</strong>: Support for multiple API providers with custom configurations</li>
                    <li><strong>Error Handling</strong>: Comprehensive error mapping and formatting for different scenarios</li>
                    <li><strong>Streaming Support</strong>: Full support for SSE (Server-Sent Events) streaming responses</li>
                    <li><strong>Configuration Management</strong>: Dynamic user configuration with hot-reloading</li>
                    <li><strong>Request Debugging</strong>: Optional request/response dumping for debugging purposes</li>
                </ul>

                <h3>Technology Stack</h3>
                <table class="data-table">
                    <tr><th>Component</th><th>Technology</th><th>Purpose</th></tr>
                    <tr><td>Web Framework</td><td>FastAPI</td><td>High-performance API framework with automatic OpenAPI docs</td></tr>
                    <tr><td>HTTP Client</td><td>HTTPX</td><td>Async HTTP client for upstream API calls</td></tr>
                    <tr><td>Data Models</td><td>Pydantic</td><td>Data validation and serialization</td></tr>
                    <tr><td>JSON Processing</td><td>orjson</td><td>Fast JSON serialization/deserialization</td></tr>
                    <tr><td>Logging</td><td>structlog</td><td>Structured logging with correlation IDs</td></tr>
                    <tr><td>Configuration</td><td>YAML + Pydantic</td><td>Type-safe configuration management</td></tr>
                </table>

                <h3>Architecture Principles</h3>
                <div class="service-grid">
                    <div class="service-card">
                        <div class="service-title">Dependency Injection</div>
                        <p>Extensive use of dependency injection for loose coupling and testability. The ServiceContainer manages all service lifecycles.</p>
                    </div>
                    <div class="service-card">
                        <div class="service-title">Pipeline Pattern</div>
                        <p>Request and response processing through configurable transformation pipelines, allowing for modular processing stages.</p>
                    </div>
                    <div class="service-card">
                        <div class="service-title">Registry Pattern</div>
                        <p>Dynamic registration and lookup of providers, models, and transformers for flexible configuration management.</p>
                    </div>
                    <div class="service-card">
                        <div class="service-title">Error Mapping</div>
                        <p>Consistent error handling through domain exception mapping, providing clear error responses to clients.</p>
                    </div>
                </div>
            </section>

            <section id="architecture">
                <h2>High-Level Architecture</h2>
                
                <div class="mermaid">
graph TB
    Client[Claude API Client] --> Proxy[CC-Proxy FastAPI App]
    
    subgraph "Middleware Stack"
        MW1[Context Middleware]
        MW2[Correlation ID Middleware]
        MW3[Security Headers Middleware]
        MW4[CORS Middleware]
        MW5[GZip Middleware]
    end
    
    Proxy --> MW1
    MW1 --> MW2
    MW2 --> MW3
    MW3 --> MW4
    MW4 --> MW5
    MW5 --> Router[Messages Router]
    
    subgraph "Service Layer"
        SC[Service Container]
        RS[Routing Service]
        PS[Pipeline Service]
        ER[Error Service]
        CF[Config Service]
    end
    
    Router --> SC
    SC --> RS
    RS --> PS
    
    subgraph "External APIs"
        A1[Anthropic API]
        A2[Custom Provider API]
        A3[Other APIs]
    end
    
    PS --> A1
    PS --> A2
    PS --> A3
    
    style Client fill:#e1f5fe
    style Proxy fill:#f3e5f5
    style SC fill:#fff3e0
    style A1 fill:#e8f5e8
                </div>

                <h3>Core Components</h3>
                
                <h4>1. FastAPI Application Layer</h4>
                <p>The main application entry point that coordinates middleware, routing, and service initialization.</p>
                
                <div class="flow-step">
                    <strong>File:</strong> app/main.py:20<br>
                    <strong>Purpose:</strong> Application bootstrap, middleware configuration, and global exception handling
                </div>

                <h4>2. Middleware Stack (LIFO Execution)</h4>
                <div class="service-grid">
                    <div class="service-card">
                        <div class="service-title">Context Middleware</div>
                        <div class="service-path">app/middlewares/context.py:8</div>
                        <p>Establishes context variables for request-scoped data sharing across the application.</p>
                    </div>
                    <div class="service-card">
                        <div class="service-title">Correlation ID Middleware</div>
                        <div class="service-path">app/middlewares/correlation_id.py:11</div>
                        <p>Injects unique correlation IDs for request tracing and debugging across service boundaries.</p>
                    </div>
                    <div class="service-card">
                        <div class="service-title">Security Headers</div>
                        <div class="service-path">app/middlewares/security_headers.py</div>
                        <p>Adds security headers to all responses for protection against common vulnerabilities.</p>
                    </div>
                </div>

                <h4>3. Service Container Architecture</h4>
                <p>The ServiceContainer (app/dependencies/services.py:31) acts as the central dependency injection container, managing the lifecycle and initialization of all services based on user configuration.</p>

                <div class="code-block">class ServiceContainer:
    def __init__(self):
        self.app_config = get_config()
        
        # Core services (always available)
        self.dumper = Dumper(self.app_config)
        self.exception_mapper = HttpExceptionMapper()
        self.error_formatter = ApiErrorFormatter()
        
        # Registries (built from user config)
        self.transformer_registry = None
        self.provider_registry = None
        self.model_registry = None</div>
            </section>

            <section id="services">
                <h2>Service Implementations</h2>

                <h3>Service Architecture Overview</h3>
                <p>The system is organized into 7 core service domains, each handling specific aspects of request processing:</p>

                <div class="service-grid">
                    <div class="service-card">
                        <div class="service-title">üîß Config Service</div>
                        <div class="service-path">app/services/config/</div>
                        <p><strong>Purpose:</strong> Manages dynamic user configuration with hot-reloading support.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>SimpleUserConfigManager (simple_user_config_manager.py:15) - Handles YAML config loading</li>
                            <li>Configuration validation and change detection</li>
                            <li>Callback system for configuration updates</li>
                        </ul>
                        <span class="badge success">Core Service</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">‚ùó Error Handling Service</div>
                        <div class="service-path">app/services/error_handling/</div>
                        <p><strong>Purpose:</strong> Comprehensive error mapping and formatting for consistent error responses.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>HttpExceptionMapper (exception_mapper.py:25) - Maps HTTP errors to domain exceptions</li>
                            <li>ApiErrorFormatter (error_formatter.py) - Formats errors for SSE responses</li>
                            <li>Domain exception hierarchy with correlation ID support</li>
                        </ul>
                        <span class="badge danger">Error Handling</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">üîÑ Pipeline Service</div>
                        <div class="service-path">app/services/pipeline/</div>
                        <p><strong>Purpose:</strong> Core request/response processing pipeline with transformation support.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>MessagesPipelineService (messages_service.py:14) - Main pipeline orchestrator</li>
                            <li>RequestPipeline (request_pipeline.py:7) - Request transformation chain</li>
                            <li>ResponsePipeline (response_pipeline.py:7) - Response transformation chain</li>
                            <li>HttpClientService (http_client.py:8) - HTTPX wrapper for upstream calls</li>
                        </ul>
                        <span class="badge primary">Core Pipeline</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">üìä Registry Service</div>
                        <div class="service-path">app/services/registry/</div>
                        <p><strong>Purpose:</strong> Dynamic registration and management of providers, models, and transformers.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>ProviderRegistry (providers.py:151) - API provider management</li>
                            <li>ModelRegistry (models.py:24) - Model-to-provider mappings</li>
                            <li>TransformerRegistry (transformers.py:100) - Dynamic transformer loading</li>
                            <li>ProviderFactory (providers.py:51) - Provider instance creation</li>
                        </ul>
                        <span class="badge info">Registry</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">üß≠ Routing Service</div>
                        <div class="service-path">app/services/routing/</div>
                        <p><strong>Purpose:</strong> Intelligent request routing based on content analysis and configuration.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>RequestProcessor (processor.py:16) - Main routing logic</li>
                            <li>RequestInspector (inspector.py:11) - Content analysis for routing decisions</li>
                            <li>Keyword-based routing (planning, background, default)</li>
                            <li>Model-to-provider resolution</li>
                        </ul>
                        <span class="badge warning">Routing Logic</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">üì° SSE Formatter Service</div>
                        <div class="service-path">app/services/sse_formatter/</div>
                        <p><strong>Purpose:</strong> Server-Sent Events formatting for streaming responses.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>AnthropicSseFormatter (anthropic_formatter.py:13) - Converts responses to Anthropic SSE format</li>
                            <li>Non-streaming response conversion to SSE events</li>
                            <li>Error event formatting for streaming contexts</li>
                        </ul>
                        <span class="badge info">SSE Processing</span>
                    </div>

                    <div class="service-card">
                        <div class="service-title">üîÄ Transformers Service</div>
                        <div class="service-path">app/services/transformers/</div>
                        <p><strong>Purpose:</strong> Built-in transformers for Anthropic API compatibility.</p>
                        <p><strong>Key Components:</strong></p>
                        <ul>
                            <li>AnthropicRequestTransformer (anthropic/transformers.py:10) - Prepares requests for Anthropic API</li>
                            <li>AnthropicResponseTransformer (anthropic/transformers.py:39) - Processes responses</li>
                            <li>AnthropicStreamTransformer (anthropic/transformers.py:47) - Handles streaming responses</li>
                        </ul>
                        <span class="badge success">Built-in Transformers</span>
                    </div>
                </div>

                <h3>Service Interdependencies</h3>
                <div class="mermaid">
graph TD
    SC[Service Container] --> CM[Config Manager]
    SC --> TR[Transformer Registry]
    SC --> PR[Provider Registry]
    SC --> MR[Model Registry]
    SC --> RP[Request Processor]
    
    CM --> UC[User Config]
    UC --> TR
    UC --> PR
    UC --> MR
    
    RP --> MR
    RP --> PR
    RP --> RI[Request Inspector]
    
    PR --> PF[Provider Factory]
    PF --> TR
    PF --> BT[Built-in Transformers]
    
    RP --> PS[Pipeline Service]
    PS --> ReqP[Request Pipeline]
    PS --> ResP[Response Pipeline]
    PS --> HC[HTTP Client]
    PS --> SSE[SSE Formatter]
    
    style SC fill:#fff3e0
    style CM fill:#e3f2fd
    style TR fill:#f3e5f5
    style PR fill:#e8f5e8
    style MR fill:#fff8e1
                </div>
            </section>

            <section id="flow">
                <h2>V1/Messages Endpoint Flow Analysis</h2>

                <div class="highlight">
                    <strong>Endpoint:</strong> POST /v1/messages<br>
                    <strong>Handler:</strong> app/routers/messages.py:17<br>
                    <strong>Purpose:</strong> Process Claude API messages with dynamic routing and transformation support
                </div>

                <h3>Complete Request Flow</h3>

                <div class="flow-step">
                    <strong>Step 1: Request Reception</strong><br>
                    FastAPI receives the request and processes it through the middleware stack (LIFO order):
                    <ul style="margin-top: 0.5rem;">
                        <li>GZip Middleware - Decompresses request if needed</li>
                        <li>CORS Middleware - Handles CORS headers</li>
                        <li>Security Headers Middleware - Adds security headers</li>
                        <li>Correlation ID Middleware - Injects correlation ID for tracing</li>
                        <li>Context Middleware - Establishes request context</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 2: Request Validation</strong><br>
                    Pydantic validates the incoming request against the ClaudeRequest model (app/common/models.py:127):
                    <ul style="margin-top: 0.5rem;">
                        <li>Model validation (required)</li>
                        <li>Messages array validation</li>
                        <li>Optional parameters (temperature, system, tools, thinking, stream)</li>
                        <li>Default values applied (max_tokens=32000, stream=True)</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 3: Routing Service Initialization</strong><br>
                    Get routing service from dependency injection (messages.py:25):
                    <ul style="margin-top: 0.5rem;">
                        <li>Retrieve ServiceContainer instance</li>
                        <li>Access RequestProcessor for routing decisions</li>
                        <li>Validate routing service availability</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 4: Dynamic Request Routing</strong><br>
                    RequestProcessor.process_request() analyzes the request (routing/processor.py:35):
                    <ul style="margin-top: 0.5rem;">
                        <li><strong>Content Analysis:</strong> RequestInspector examines message content</li>
                        <li><strong>Keyword Matching:</strong> Checks for planning/background keywords</li>
                        <li><strong>Complexity Scoring:</strong> Analyzes word count, tools, thinking mode</li>
                        <li><strong>Routing Decision:</strong> Routes to 'planning', 'background', or 'default'</li>
                        <li><strong>Model Resolution:</strong> Maps routing key to specific model ID</li>
                        <li><strong>Provider Lookup:</strong> Finds provider for the target model</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 5: Pipeline Service Creation</strong><br>
                    Create MessagesPipelineService instance for the target provider:
                    <ul style="margin-top: 0.5rem;">
                        <li>RequestPipeline with provider's request transformers</li>
                        <li>ResponsePipeline with provider's response transformers</li>
                        <li>HttpClientService for upstream API calls</li>
                        <li>SseFormatter for streaming response formatting</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 6: Core Services Initialization</strong><br>
                    Retrieve core services for request processing (messages.py:55):
                    <ul style="margin-top: 0.5rem;">
                        <li><strong>Dumper:</strong> For optional request/response debugging</li>
                        <li><strong>ExceptionMapper:</strong> For error handling</li>
                        <li><strong>ErrorFormatter:</strong> For SSE error formatting</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 7: Request Preprocessing</strong><br>
                    Prepare request for pipeline processing (messages.py:61-67):
                    <ul style="margin-top: 0.5rem;">
                        <li>Convert ClaudeRequest to dictionary format</li>
                        <li>Add routing information for debugging</li>
                        <li>Initialize dumper handles for optional logging</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Step 8: Streaming Response Generation</strong><br>
                    Create async generator for streaming response (messages.py:68):
                    <ul style="margin-top: 0.5rem;">
                        <li>Call pipeline_service.process_unified()</li>
                        <li>Handle both streaming and non-streaming upstream responses</li>
                        <li>Apply transformations and convert to SSE format</li>
                        <li>Dump response chunks if debugging enabled</li>
                    </ul>
                </div>

                <h3>Pipeline Processing Details</h3>

                <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant MW as Middleware Stack
    participant R as Messages Router
    participant RS as Routing Service
    participant PS as Pipeline Service
    participant HTTP as HTTP Client
    participant API as External API

    C->>MW: POST /v1/messages
    MW->>MW: Process middleware (Context, CorrelationID, etc.)
    MW->>R: Route to messages handler
    R->>R: Validate ClaudeRequest with Pydantic
    R->>RS: Get routing service
    RS->>RS: Analyze request content
    RS->>RS: Determine routing key (planning/background/default)
    RS->>RS: Resolve model and provider
    RS->>R: Return (routing_key, model_id, pipeline_service)
    R->>PS: Create pipeline for provider
    PS->>PS: Apply request transformers
    PS->>HTTP: Execute HTTP request
    HTTP->>API: Forward to external API
    API-->>HTTP: Stream/non-stream response
    HTTP-->>PS: Raw response chunks
    PS->>PS: Apply response transformers
    PS->>PS: Convert to SSE format if needed
    PS-->>R: Transformed response chunks
    R-->>MW: Stream response
    MW-->>C: SSE formatted response
                </div>

                <h3>Error Handling Flow</h3>
                <p>The system implements comprehensive error handling at multiple levels:</p>

                <div class="flow-step">
                    <strong>HTTP Status Errors (HTTPStatusError)</strong><br>
                    Mapped to domain exceptions by HttpExceptionMapper (messages.py:75-81):
                    <ul style="margin-top: 0.5rem;">
                        <li>401 ‚Üí AuthenticationException</li>
                        <li>403 ‚Üí AuthorizationException</li>
                        <li>404 ‚Üí ExternalApiNotFoundException</li>
                        <li>413 ‚Üí RequestTooLargeException</li>
                        <li>429 ‚Üí RateLimitException</li>
                        <li>500 ‚Üí ExternalApiServerException</li>
                        <li>529 ‚Üí ExternalApiOverloadedException</li>
                    </ul>
                </div>

                <div class="flow-step">
                    <strong>Pipeline Exceptions</strong><br>
                    Domain-specific exceptions from transformation pipeline (messages.py:89-94)
                </div>

                <div class="flow-step">
                    <strong>Unexpected Errors</strong><br>
                    Catch-all handler for unknown exceptions with full stack traces (messages.py:95-103)
                </div>

                <h3>Request Inspector Logic</h3>
                <p>The RequestInspector (routing/inspector.py:11) uses sophisticated content analysis:</p>

                <table class="data-table">
                    <tr><th>Routing Type</th><th>Trigger Conditions</th><th>Example Keywords</th></tr>
                    <tr>
                        <td><span class="badge warning">Planning</span></td>
                        <td>planning_score > 0.3 OR complexity_score > 0.5 OR has_thinking OR (has_tools AND word_count > 100)</td>
                        <td>plan, strategy, analyze, complex, think, solve, architecture</td>
                    </tr>
                    <tr>
                        <td><span class="badge info">Background</span></td>
                        <td>background_score > 0.2 AND complexity_score < 0.2 AND word_count < 50 AND no tools AND no thinking</td>
                        <td>quick, simple, basic, summarize, list, translate, yes, no</td>
                    </tr>
                    <tr>
                        <td><span class="badge primary">Default</span></td>
                        <td>All other requests that don't match planning or background criteria</td>
                        <td>General conversational requests</td>
                    </tr>
                </table>
            </section>

            <section id="diagrams">
                <h2>Interactive Architecture Diagrams</h2>

                <div class="interactive-controls">
                    <h3>Service Interaction Visualization</h3>
                    <p>Click on services to highlight their relationships:</p>
                    <button class="btn" onclick="highlightService('config')">Config Service</button>
                    <button class="btn" onclick="highlightService('pipeline')">Pipeline Service</button>
                    <button class="btn" onclick="highlightService('routing')">Routing Service</button>
                    <button class="btn" onclick="highlightService('registry')">Registry Service</button>
                    <button class="btn" onclick="highlightService('error')">Error Service</button>
                    <button class="btn" onclick="resetHighlight()">Reset</button>
                </div>

                <div id="flowDiagram"></div>

                <h3>Request Processing Pipeline</h3>
                <div class="mermaid">
graph TD
    Start([Client Request]) --> MW{Middleware Stack}
    MW --> |Context, Correlation ID| Validate[Request Validation]
    Validate --> |Pydantic ClaudeRequest| Route{Routing Service}
    Route --> |Content Analysis| Inspect[Request Inspector]
    Inspect --> |Keywords + Complexity| Decision{Routing Decision}
    
    Decision --> |planning_score > 0.3| Planning[Planning Model]
    Decision --> |background_score > 0.2 + simple| Background[Background Model]
    Decision --> |default| Default[Default Model]
    
    Planning --> Provider1[Provider A]
    Background --> Provider2[Provider B]
    Default --> Provider3[Provider C]
    
    Provider1 --> Transform[Request Transformation]
    Provider2 --> Transform
    Provider3 --> Transform
    
    Transform --> HTTP[HTTP Client Service]
    HTTP --> |Stream/Non-stream| API[External API]
    API --> Response[Response Processing]
    Response --> SSE[SSE Formatting]
    SSE --> Client([Streaming Response])
    
    style Start fill:#e1f5fe
    style Client fill:#e1f5fe
    style Planning fill:#fff3e0
    style Background fill:#e8f5e8
    style Default fill:#f3e5f5
    style API fill:#ffebee
                </div>

                <h3>Service Dependencies Graph</h3>
                <div class="mermaid">
graph LR
    subgraph "Application Layer"
        Main[main.py]
        Router[messages.py]
    end
    
    subgraph "Service Container"
        SC[ServiceContainer]
        DI[Dependency Injection]
    end
    
    subgraph "Configuration"
        Config[Config Service]
        UserConfig[User Config YAML]
    end
    
    subgraph "Registries"
        TR[Transformer Registry]
        PR[Provider Registry]
        MR[Model Registry]
    end
    
    subgraph "Processing"
        RS[Routing Service]
        PS[Pipeline Service]
        HTTP[HTTP Client]
    end
    
    subgraph "Support Services"
        EH[Error Handling]
        SSE[SSE Formatter]
        Dump[Request Dumper]
    end
    
    Main --> SC
    Router --> DI
    SC --> Config
    Config --> UserConfig
    SC --> TR
    SC --> PR
    SC --> MR
    UserConfig --> TR
    UserConfig --> PR
    UserConfig --> MR
    DI --> RS
    RS --> MR
    RS --> PR
    RS --> PS
    PS --> HTTP
    PS --> SSE
    DI --> EH
    DI --> Dump
    
    style Main fill:#e3f2fd
    style SC fill:#fff3e0
    style Config fill:#e8f5e8
    style UserConfig fill:#f1f8e9
                </div>
            </section>
        </main>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active classes
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked nav
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    document.getElementById(targetId).classList.add('active');
                });
            });
        });

        // Interactive diagram functionality
        let currentHighlight = null;

        const serviceRelationships = {
            config: ['pipeline', 'registry', 'routing'],
            pipeline: ['config', 'registry', 'error'],
            routing: ['config', 'registry', 'pipeline'],
            registry: ['config', 'pipeline', 'routing'],
            error: ['pipeline']
        };

        function highlightService(serviceType) {
            resetHighlight();
            currentHighlight = serviceType;
            
            // Create interactive flow diagram with D3.js
            createServiceDiagram(serviceType);
            
            // Update button states
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(serviceType)) {
                    btn.classList.add('active');
                }
            });
        }

        function resetHighlight() {
            currentHighlight = null;
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
            });
            createServiceDiagram();
        }

        function createServiceDiagram(highlight = null) {
            const container = d3.select('#flowDiagram');
            container.selectAll('*').remove();

            const width = container.node().getBoundingClientRect().width;
            const height = 800;

            const svg = container
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Service nodes data
            const services = [
                { id: 'client', name: 'Client', x: width * 0.1, y: height * 0.5, type: 'external' },
                { id: 'middleware', name: 'Middleware\nStack', x: width * 0.25, y: height * 0.5, type: 'middleware' },
                { id: 'router', name: 'Messages\nRouter', x: width * 0.4, y: height * 0.5, type: 'router' },
                { id: 'config', name: 'Config\nService', x: width * 0.2, y: height * 0.2, type: 'config' },
                { id: 'routing', name: 'Routing\nService', x: width * 0.55, y: height * 0.3, type: 'routing' },
                { id: 'registry', name: 'Registry\nServices', x: width * 0.7, y: height * 0.2, type: 'registry' },
                { id: 'pipeline', name: 'Pipeline\nService', x: width * 0.7, y: height * 0.5, type: 'pipeline' },
                { id: 'error', name: 'Error\nHandling', x: width * 0.55, y: height * 0.7, type: 'error' },
                { id: 'api', name: 'External\nAPI', x: width * 0.85, y: height * 0.5, type: 'external' }
            ];

            // Links data
            const links = [
                { source: 'client', target: 'middleware' },
                { source: 'middleware', target: 'router' },
                { source: 'router', target: 'routing' },
                { source: 'routing', target: 'registry' },
                { source: 'routing', target: 'pipeline' },
                { source: 'pipeline', target: 'api' },
                { source: 'config', target: 'registry' },
                { source: 'config', target: 'routing' },
                { source: 'error', target: 'router' },
                { source: 'pipeline', target: 'error' }
            ];

            // Color scheme
            const colors = {
                external: '#ff6b6b',
                middleware: '#4ecdc4',
                router: '#45b7d1',
                config: '#96ceb4',
                routing: '#ffeaa7',
                registry: '#dda0dd',
                pipeline: '#98d8c8',
                error: '#f7dc6f'
            };

            // Draw links
            svg.selectAll('.link')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('x1', d => services.find(s => s.id === d.source).x)
                .attr('y1', d => services.find(s => s.id === d.source).y)
                .attr('x2', d => services.find(s => s.id === d.target).x)
                .attr('y2', d => services.find(s => s.id === d.target).y)
                .style('stroke', d => {
                    if (highlight) {
                        const related = serviceRelationships[highlight] || [];
                        if (d.source === highlight || d.target === highlight || 
                            related.includes(d.source) || related.includes(d.target)) {
                            return '#e74c3c';
                        }
                        return '#bdc3c7';
                    }
                    return '#34495e';
                })
                .style('stroke-width', d => {
                    if (highlight) {
                        const related = serviceRelationships[highlight] || [];
                        if (d.source === highlight || d.target === highlight || 
                            related.includes(d.source) || related.includes(d.target)) {
                            return 3;
                        }
                        return 1;
                    }
                    return 2;
                })
                .style('opacity', 0.7);

            // Draw nodes
            const nodes = svg.selectAll('.node')
                .data(services)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            nodes.append('circle')
                .attr('r', 40)
                .style('fill', d => {
                    if (highlight === d.type) {
                        return '#e74c3c';
                    }
                    if (highlight && serviceRelationships[highlight] && serviceRelationships[highlight].includes(d.type)) {
                        return '#f39c12';
                    }
                    return colors[d.type] || '#95a5a6';
                })
                .style('stroke', '#2c3e50')
                .style('stroke-width', 2)
                .style('opacity', d => {
                    if (!highlight) return 1;
                    const related = serviceRelationships[highlight] || [];
                    if (d.type === highlight || related.includes(d.type)) {
                        return 1;
                    }
                    return 0.5;
                });

            nodes.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .style('font-size', '11px')
                .style('font-weight', 'bold')
                .style('fill', '#2c3e50')
                .selectAll('tspan')
                .data(d => d.name.split('\n'))
                .enter()
                .append('tspan')
                .attr('x', 0)
                .attr('dy', (d, i) => i === 0 ? 0 : '1.2em')
                .text(d => d);

            // Add click handlers
            nodes.on('click', function(event, d) {
                if (d.type !== 'external' && d.type !== 'middleware' && d.type !== 'router') {
                    highlightService(d.type);
                }
            });
        }

        // Initialize the diagram
        setTimeout(() => {
            createServiceDiagram();
        }, 1000);

        // Handle window resize
        window.addEventListener('resize', function() {
            if (currentHighlight) {
                createServiceDiagram(currentHighlight);
            } else {
                createServiceDiagram();
            }
        });
    </script>
</body>
</html>